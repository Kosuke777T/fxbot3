  fxbot3 実装まとめ                                                                                                                                                                                                                   
  実装した機能一覧                                                                                                 

  ---
  1. Triple Barrier ラベリング (src/fxbot/model/labeling.py)

  Marcos Lopez de Prado の手法に基づき、教師あり学習のラベルを生成する仕組みです。

  仕組み:
  - 各バーから horizon バー先まで価格を走査する
  - TP バリア（ボラ × tp_mult）に先にヒット → ラベル +1 (up)
  - SL バリア（ボラ × sl_mult）に先にヒット → ラベル -1 (down)
  - どちらにもヒットしない → ラベル 0 (neutral)

  従来の「N本後の騰落」よりも現実の損益構造に近いラベルが得られます。

  ---
  2. 分類モード学習 (src/fxbot/model/trainer.py)

  config.yaml の model.mode を切り替えることで、回帰と分類を使い分けられます。

  ┌────────────────┬──────────────────────────────┬──────────────────────┐
  │     モード     │          ターゲット          │   LightGBM目的関数   │
  ├────────────────┼──────────────────────────────┼──────────────────────┤
  │ regression     │ 対数リターン（連続値）       │ MAE                  │
  ├────────────────┼──────────────────────────────┼──────────────────────┤
  │ classification │ Triple Barrierラベル {0,1,2} │ multiclass (logloss) │
  └────────────────┴──────────────────────────────┴──────────────────────┘

  時系列サンプルウェイト:
  - 最近のデータほど重みが大きくなる指数減衰（decay=0.9995）を適用
  - 概念ドリフト（市場構造の変化）への対策

  ---
  3. 市場レジーム判定特徴量 (src/fxbot/features/regime.py)

  モデルに「現在の市場環境」を教える特徴量群を追加します。

  ┌──────────────────────┬──────────────────────────────────────────────┐
  │        特徴量        │                     内容                     │
  ├──────────────────────┼──────────────────────────────────────────────┤
  │ regime_adx           │ ADX値（トレンド強度）                        │
  ├──────────────────────┼──────────────────────────────────────────────┤
  │ regime_trend_up/down │ +DI/-DI + ADX≥20 でトレンド方向判定          │
  ├──────────────────────┼──────────────────────────────────────────────┤
  │ regime_ranging       │ ADX<20 でレンジ判定                          │
  ├──────────────────────┼──────────────────────────────────────────────┤
  │ regime_bb_width_norm │ Bollinger Band幅の相対位置（スクイーズ検出） │
  ├──────────────────────┼──────────────────────────────────────────────┤
  │ regime_squeeze       │ BBwidthが過去50バーの下位20%                 │
  ├──────────────────────┼──────────────────────────────────────────────┤
  │ regime_hurst         │ Hurst指数（H>0.5=トレンド持続性）            │
  ├──────────────────────┼──────────────────────────────────────────────┤
  │ regime_vol_ratio     │ 短期/長期ボラティリティ比                    │
  └──────────────────────┴──────────────────────────────────────────────┘

  ---
  4. シグナルフィルター (src/fxbot/strategy/signal.py)

  market_filter.enabled: true にすると、以下の条件に該当する場合は自動的に HOLD になります。

  ┌──────────────────────┬──────────────────────────────────────────────────────────────┐
  │      フィルター      │                             条件                             │
  ├──────────────────────┼──────────────────────────────────────────────────────────────┤
  │ レンジ相場フィルター │ ADX<20（レンジ）ではエントリーしない                         │
  ├──────────────────────┼──────────────────────────────────────────────────────────────┤
  │ スプレッドフィルター │ スプレッド > max_spread_pips (デフォルト3.0pips)             │
  ├──────────────────────┼──────────────────────────────────────────────────────────────┤
  │ 低ボラフィルター     │ ATR% < 0.02%（動きが小さすぎる）                             │
  ├──────────────────────┼──────────────────────────────────────────────────────────────┤
  │ 過大ボラフィルター   │ ATR% > 0.5%（指標発表など異常相場）                          │
  ├──────────────────────┼──────────────────────────────────────────────────────────────┤
  │ セッションフィルター │ session_only: true でロンドン(7-16UTC)・NY(13-22UTC)以外HOLD │
  ├──────────────────────┼──────────────────────────────────────────────────────────────┤
  │ 信頼度フィルター     │ 分類モデルの確率 < min_confidence                            │
  └──────────────────────┴──────────────────────────────────────────────────────────────┘

  ---
  5. 取引ログ (src/fxbot/trade_logger.py)

  trade_logging.enabled: true にすると、全取引を SQLite に記録します。

  記録される項目:
  - エントリー時: symbol, direction, entry_price, SL/TP, lot, 予測値, 信頼度, ATR, 残高, model_version
  - クローズ時: exit_price, exit_reason, PnL

  主なメソッド:
  logger.log_entry(record)      # エントリー記録
  logger.log_exit(ticket, ...)  # クローズ記録
  logger.get_recent_trades(50)  # 直近50件取得
  logger.get_rolling_metrics(20) # 直近20件のメトリクス計算
  logger.export_csv("out.csv")  # CSVエクスポート

  ---
  6. モデル劣化検知 (src/fxbot/model/monitor.py)

  ModelMonitor が取引ログを監視し、パフォーマンス低下を検知します。

  チェック項目:
  - 直近N件の 勝率 が min_win_rate を下回る
  - 直近N件の シャープレシオ が min_sharpe を下回る

  retraining.enabled: true と組み合わせることで、劣化検知 → 自動再学習が可能です。

  ---
  設定ファイルの使い方 (config/default_settings.yaml)

  分類モードに切り替える

  model:
    mode: classification   # regression → classification

  trading:
    min_confidence: 0.55   # 確率55%未満はHOLD（推奨値）

  市場環境フィルターを有効にする

  market_filter:
    enabled: true
    min_adx: 20.0          # レンジ除外
    max_spread_pips: 3.0   # 広スプレッド除外
    session_only: true     # ロンドン・NYセッションのみ

  取引ログを有効にする

  trade_logging:
    enabled: true
    db_path: "data/trades.db"

  モデル劣化監視を有効にする

  retraining:
    enabled: true
    interval_hours: 168    # 週1で自動再学習
    monitor_window: 20     # 直近20件で監視
    min_win_rate: 0.40     # 勝率40%未満で警告
    min_sharpe: 0.0        # シャープ0未満で警告

  ---
  各機能の関係図

  OHLCVデータ
      │
      ▼
  build_feature_matrix()
      ├── regime.py（市場レジーム特徴量を追加）
      └── その他特徴量（trend/momentum/volatility等）
      │
      ▼
  trainer.py
      ├── mode=regression → 対数リターン予測
      └── mode=classification → Triple Barrierラベル予測
      │
      ▼
  predictor.py → generate_signal()
      ├── market_filter（レンジ/スプレッド/ボラ/セッション）
      ├── confidence filter（分類モデルの確率閾値）
      └── BUY / SELL / HOLD
      │
      ▼
  trade_logger.py（SQLite記録）
      │
      ▼
  model/monitor.py（勝率・シャープ監視 → 劣化アラート）

  ===================================================================
  設定タブ 詳細ガイド
  ===================================================================

  設定タブは4つのサブタブに分かれています。
  すべての変更は画面下部の「設定保存」ボタンで一括保存されます。

  ---
  ■ 口座タブ
  ---

  MT5ブローカー口座の接続情報を管理します。

  ┌──────────────┬─────────────────────────────────────────────────────────┐
  │     項目     │                         説明                            │
  ├──────────────┼─────────────────────────────────────────────────────────┤
  │ アクティブ口座 │ demo / real を切り替えるドロップダウン。                │
  │              │ 選択すると下のフィールドが自動で切り替わる。             │
  ├──────────────┼─────────────────────────────────────────────────────────┤
  │ サーバー     │ MT5ブローカーのサーバー名                               │
  │              │ 例: GaitameFinest-Demo, GaitameFinest-LIVE              │
  ├──────────────┼─────────────────────────────────────────────────────────┤
  │ ログインID   │ MT5口座番号（数値）                                     │
  ├──────────────┼─────────────────────────────────────────────────────────┤
  │ パスワード   │ MT5パスワード（マスク表示）                              │
  ├──────────────┼─────────────────────────────────────────────────────────┤
  │ 口座タイプ   │ DEMO（緑）/ REAL（赤）で表示。                          │
  │              │ リアル口座への切替時は確認ダイアログが出る。              │
  ├──────────────┼─────────────────────────────────────────────────────────┤
  │ 口座切替     │ 選択中の口座でMT5に接続し直すボタン。                   │
  ├──────────────┼─────────────────────────────────────────────────────────┤
  │ 発注テスト   │ USDJPYを最小ロットで成行BUYし、10秒後に自動決済する     │
  │              │ テスト機能。MT5の自動売買が有効でないとエラーになる。     │
  └──────────────┴─────────────────────────────────────────────────────────┘

  操作手順:
  1. アクティブ口座でdemo/realを選択
  2. 必要に応じてサーバー・ログインID・パスワードを編集
  3.「口座切替」ボタンで接続を切り替え
  4. 初回接続確認には「発注テスト」が便利

  ---
  ■ 取引・リスク タブ
  ---

  ◆ 取引設定

  ┌────────────────┬───────────┬────────────────────────────────────────────┐
  │      項目      │ デフォルト │                   説明                     │
  ├────────────────┼───────────┼────────────────────────────────────────────┤
  │ 最大ポジション数 │     5     │ 同時に保持できるポジションの上限。         │
  │                │           │ 増やすと分散効果が上がるが、1つの暴落で     │
  │                │           │ 複数ポジションが同時にSLヒットするリスクも。 │
  ├────────────────┼───────────┼────────────────────────────────────────────┤
  │ 予測ホライゾン │     6     │ 何本先の値動きを予測するか（M5足=30分先）。 │
  │                │           │ 値が大きいほど長期予測。学習データの        │
  │                │           │ ターゲットにも影響する。                    │
  ├────────────────┼───────────┼────────────────────────────────────────────┤
  │ 最小予測閾値   │  0.0002   │ 予測値（対数リターン）の絶対値がこの値以上  │
  │                │           │ でないとエントリーしない。大きくすると      │
  │                │           │ 取引頻度が減り、厳選エントリーになる。      │
  │                │           │ 目安: 0.0001（積極的）〜 0.0005（保守的）   │
  ├────────────────┼───────────┼────────────────────────────────────────────┤
  │ 最大ロット     │   0.10    │ 1注文あたりの上限ロット。リスク計算で       │
  │                │           │ 算出されたロットがこの値を超えないようクランプ。│
  └────────────────┴───────────┴────────────────────────────────────────────┘

  ◆ リスク管理

  ┌──────────────────┬───────────┬──────────────────────────────────────────┐
  │       項目       │ デフォルト │                  説明                    │
  ├──────────────────┼───────────┼──────────────────────────────────────────┤
  │ 1トレードリスク  │   0.020   │ 口座残高に対する1回の取引で許容する最大    │
  │                  │           │ 損失割合。0.02 = 残高の2%。               │
  │                  │           │ ロット計算: リスク金額÷(ATR×SL倍率×10万)  │
  │                  │           │ 目安: 0.01（堅実）〜 0.03（攻め）         │
  ├──────────────────┼───────────┼──────────────────────────────────────────┤
  │ ATR SL倍率      │   2.0     │ ATR（平均的な値幅）の何倍をSL距離にするか。│
  │                  │           │ 小さい → SLが近い → 損切り頻度↑ 損失額↓   │
  │                  │           │ 大きい → SLが遠い → 損切り頻度↓ 損失額↑   │
  │                  │           │ 目安: 1.5（タイト）〜 3.0（ゆとり）       │
  ├──────────────────┼───────────┼──────────────────────────────────────────┤
  │ ATR TP倍率      │   3.0     │ ATRの何倍をTP距離にするか。               │
  │                  │           │ SL倍率より大きくするとリスクリワード>1。   │
  │                  │           │ TP/SL = 3.0/2.0 → リスクリワード比 1.5    │
  │                  │           │ 目安: SL倍率の1.5〜2倍                    │
  └──────────────────┴───────────┴──────────────────────────────────────────┘

  リスク管理の仕組み（3層ストップ）:
  - Layer 1: ATRベースでSL/TPの基本距離を算出
  - Layer 2: 予測値が大きいほどTPを広げ、SLを少し狭める微調整
  - Layer 3: トレーリングストップ（含み益がATR×1.0倍に達したら起動、
    ATR×1.5倍の距離で追従）

  設定例:
  - 堅実運用: リスク=0.010, SL倍率=2.5, TP倍率=4.0
  - バランス: リスク=0.020, SL倍率=2.0, TP倍率=3.0（デフォルト）
  - 積極運用: リスク=0.030, SL倍率=1.5, TP倍率=3.0

  ---
  ■ モデル タブ
  ---

  ◆ 学習モード

  2種類の学習モードが選択できます。モード変更後は再学習が必要です。

  ┌────────────────┬──────────────────────────────────────────────────────┐
  │ regression     │ デフォルト。対数リターン（連続値）を予測する。        │
  │  （回帰モード）│                                                      │
  │                │ ターゲット: log(close[t+h] / close[t])               │
  │                │ 目的関数: MAE（平均絶対誤差）                         │
  │                │                                                      │
  │                │ 特徴:                                                 │
  │                │ ・値動きの「大きさ」と「方向」を両方予測              │
  │                │ ・予測値が大きいほどロットを増やす仕組みと相性が良い  │
  │                │ ・小さな値動きも拾うためトレード頻度が多め            │
  │                │ ・min_confidence は無効（0.0のまま）                  │
  ├────────────────┼──────────────────────────────────────────────────────┤
  │ classification │ Triple Barrierラベルで「勝ち／負け／引分け」を予測。  │
  │ （分類モード） │                                                      │
  │                │ ターゲット: 3クラス                                   │
  │                │   0 = SLバリアヒット（下落）                          │
  │                │   1 = どちらにもヒットせず（中立）                    │
  │                │   2 = TPバリアヒット（上昇）                          │
  │                │ 目的関数: multiclass logloss                          │
  │                │                                                      │
  │                │ 特徴:                                                 │
  │                │ ・「勝てるか負けるか」に特化した学習                  │
  │                │ ・各クラスの確率が出力される（信頼度として利用可能）   │
  │                │ ・min_confidence と組み合わせて低確率の取引を除外できる│
  │                │ ・トレード頻度は減るが勝率が向上する傾向              │
  └────────────────┴──────────────────────────────────────────────────────┘

  使い分けの指針:
  - まずはデフォルトの regression で運用を開始
  - 勝率が低い場合は classification + min_confidence=0.55 を試す
  - バックテストで両モードを比較して自分の通貨ペアに合う方を選ぶ

  ◆ 最低信頼度（分類モード専用）

  ┌───────────┬───────────────────────────────────────────────────────────┐
  │    値     │                        動作                              │
  ├───────────┼───────────────────────────────────────────────────────────┤
  │    0.00   │ 無効（全予測でエントリー）。regression モードはこの値。   │
  ├───────────┼───────────────────────────────────────────────────────────┤
  │    0.50   │ 確率50%超の予測のみエントリー（ほぼフィルターなし）      │
  ├───────────┼───────────────────────────────────────────────────────────┤
  │    0.55   │ 推奨値。確率55%以上の「やや自信あり」な予測に絞る。      │
  │           │ 勝率が数%向上する傾向。                                  │
  ├───────────┼───────────────────────────────────────────────────────────┤
  │    0.60   │ 厳選。トレード数は大幅に減るが勝率は高くなる。           │
  ├───────────┼───────────────────────────────────────────────────────────┤
  │  0.70以上 │ 非常に厳選。トレードがほぼ発生しない可能性がある。       │
  └───────────┴───────────────────────────────────────────────────────────┘

  classificationモードでの推奨設定:
    学習モード: classification
    最低信頼度: 0.55

  ◆ 市場環境フィルター（勝率向上）

  「フィルターを有効にする」にチェックを入れると、不利な相場環境での
  エントリーを自動的にHOLD（見送り）にします。
  トレード数は減りますが、勝率とリスクリワードの向上が見込めます。

  各フィルターの詳細:

  ┌──────────────────────────┬────────────────────────────────────────────┐
  │ フィルターを有効にする   │ 全フィルターのマスタースイッチ。           │
  │                          │ OFFなら以下の個別設定はすべて無視される。  │
  ├──────────────────────────┼────────────────────────────────────────────┤
  │ 最小ADX（トレンド判定）  │ ADX（Average Directional Index）が         │
  │ デフォルト: 20.0         │ この値未満の場合、レンジ相場と判定して     │
  │                          │ エントリーしない。                         │
  │                          │                                            │
  │                          │ ADX < 20 → レンジ（方向感なし）→ HOLD     │
  │                          │ ADX ≥ 20 → トレンド発生中 → エントリー可  │
  │                          │                                            │
  │                          │ 値を上げる（例:25）→ 強いトレンドのみに限定│
  │                          │ 値を下げる（例:15）→ 弱いトレンドも許可   │
  ├──────────────────────────┼────────────────────────────────────────────┤
  │ 最大スプレッド (pips)    │ スプレッドがこの値を超えるとHOLD。         │
  │ デフォルト: 3.0          │ 早朝や指標発表直後はスプレッドが広がる。   │
  │                          │ 広スプレッドでのエントリーはコスト負けする  │
  │                          │ ため、自動で見送る。                       │
  │                          │                                            │
  │                          │ 主要通貨ペア: 2.0〜3.0が目安              │
  │                          │ マイナー通貨: 5.0程度に広げる              │
  ├──────────────────────────┼────────────────────────────────────────────┤
  │ ロンドン・NYセッション   │ チェックを入れると、流動性の高い時間帯のみ │
  │ のみ取引                 │ エントリーする。                           │
  │                          │                                            │
  │                          │ ロンドン: 7:00〜16:00 UTC (16:00〜25:00 JST)│
  │                          │ ニューヨーク: 13:00〜22:00 UTC (22:00〜翌7:00 JST)│
  │                          │                                            │
  │                          │ アジア時間（日本の日中）はボラティリティが  │
  │                          │ 低く、スプレッドも広がりがちなため除外。    │
  └──────────────────────────┴────────────────────────────────────────────┘

  さらに、コード内部では以下のフィルターも自動適用されます（GUI設定なし）:
  - 低ボラフィルター: ATR% < 0.02% → 値動きが小さすぎて利益が出ない
  - 過大ボラフィルター: ATR% > 0.5% → 経済指標発表など異常相場

  フィルター推奨設定:
  - 保守的（勝率重視）:
      フィルター有効 + ADX 25.0 + スプレッド 2.0 + セッション限定ON
  - バランス（デフォルト）:
      フィルター有効 + ADX 20.0 + スプレッド 3.0 + セッション限定OFF
  - 積極的（トレード数重視）:
      フィルター無効

  ---
  ■ ログ タブ
  ---

  ◆ 取引ログ（勝率分析）

  ┌──────────────────────┬──────────────────────────────────────────────────┐
  │ 取引ログを有効にする │ チェックを入れると、すべてのエントリー・決済を    │
  │                      │ SQLiteデータベースに記録する。                    │
  │                      │ 勝率分析やモデル劣化検知の基盤データになる。      │
  ├──────────────────────┼──────────────────────────────────────────────────┤
  │ DB保存パス           │ SQLiteファイルのパス（プロジェクトルート基準）。   │
  │ デフォルト:          │ 通常はデフォルトのまま変更不要。                  │
  │ data/trades.db       │                                                  │
  └──────────────────────┴──────────────────────────────────────────────────┘

  記録される情報:
  - エントリー時: 通貨ペア, 方向, 価格, SL/TP, ロット, 予測値, 信頼度,
    ATR, 口座残高, モデルバージョン
  - 決済時: 決済価格, 決済理由（TP/SL/トレーリング/手動）, 損益額

  取引ログの活用:
  1. 勝率・損益の推移を確認
  2. ModelMonitor（自動再学習トリガー）がログを監視して劣化を検知
  3. CSVエクスポートで外部ツール（Excel等）での分析も可能

  取引ログは有効にしておくことを推奨します。

  ---
  ■ 設定保存について
  ---

  - どのサブタブを開いていても、画面下部の「設定保存」ボタンで
    全タブの変更が一括保存されます。
  - 保存するとアプリ内部の設定オブジェクトが即時更新されます。
  - 口座切替は「口座切替」ボタンで別途実行する必要があります
    （設定保存だけでは接続は切り替わりません）。